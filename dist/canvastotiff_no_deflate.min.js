/*
	canvas-to-tiff 1.6.0
	(c) epistemex.com 2015-2016
	MIT License
*/
"use strict";var CanvasToTIFF={_dly:7,toArrayBuffer:function(f,c,D){D=D||{};var A=this,L=f.width,t=f.height,E=0,B=0,x=258,m=0,C=[],v,J="canvas-to-tiff 1\0",z=!!D.littleEndian,j=+(D.dpiX||D.dpi||96)|0,k=+(D.dpiY||D.dpi||96)|0,d=typeof ezlib!=="undefined"&&typeof ezlib.Deflate!=="undefined",g=typeof D.compressionLevel==="number"?Math.max(0,Math.min(9,D.compressionLevel)):6,i,u,F,y,p,n,o,K;i=f.getContext("2d");if(!i){i=document.createElement("canvas").getContext("2d");if(i){i.canvas.width=L;i.canvas.height=t;i.drawImage(f,0,0)}else{if(D.onError){D.onError({msg:"Cannot obtain a 2D context."})}else{console.log(e)}}}u=(function(h){try{return h.getImageData(0,0,L,t)}catch(w){if(D.onError){D.onError(w)}else{console.log(w)}}})(i);if(d&&(typeof D.compress==="boolean"?D.compress:!0)){ezlib.deflateAsync(u.data,{level:g},function(h){F=h.result;q()},function(h){if(D.onError){D.onError(h)}else{console.log(h)}})}else{q()}function q(){y=F?F.length:u.data.length;p=x+y;n=new ArrayBuffer(p);o=new Uint8Array(n);K=new DataView(n);G(z?18761:19789);G(42);H(8);b();a(254,4,1,0);a(256,4,1,L);a(257,4,1,t);a(258,3,4,B,8);a(259,3,1,F?8:1);a(262,3,1,2);a(273,4,1,x,0);a(277,3,1,4);a(279,4,1,y);a(282,5,1,B,8);a(283,5,1,B,8);a(296,3,1,2);a(305,2,J.length,B,s(J));a(306,2,20,B,20);a(338,3,1,2);l();H(524296);H(524296);H(j);H(1);H(k);H(1);I(J);I(r());o.set(F?F:u.data,x);setTimeout(function(){c(n)},A._dly)}function r(){var h=new Date();return h.getFullYear()+":"+w(h.getMonth()+1)+":"+w(h.getDate())+" "+w(h.getHours())+":"+w(h.getMinutes())+":"+w(h.getSeconds());function w(M){return M<10?"0"+M:M}}function G(h){K.setUint16(E,h,z);E+=2}function H(h){K.setUint32(E,h,z);E+=4}function I(w){var h=0;while(h<w.length){K.setUint8(E++,w.charCodeAt(h++)&255)}if(E&1){E++}}function s(w){var h=w.length;return h&1?h+1:h}function a(M,N,h,O,w){G(M);G(N);H(h);if(w){B+=w;C.push(E)}if(h===1&&N===3&&!w){G(O);G(0)}else{H(O)}m++}function b(h){v=h||E;E+=2}function l(){K.setUint16(v,m,z);H(0);var h=14+m*12;for(var w=0,N,M;w<C.length;w++){N=C[w];M=K.getUint32(N,z);K.setUint32(N,M+h,z)}}},toBlob:function(b,a,c){this.toArrayBuffer(b,function(d){a(new Blob([d],{type:"image/tiff"}))},c)},toObjectURL:function(b,a,c){this.toBlob(b,function(d){a((window.URL||window.webkitURL).createObjectURL(d))},c)},toDataURL:function(b,a,d){var c=this;c.toArrayBuffer(b,function(m){var k=new Uint8Array(m),h=1<<20,g=h,j="",f="",n=0,o=k.length;(function p(){while(n<o&&g-->0){j+=String.fromCharCode(k[n++])}if(n<o){g=h;setTimeout(p,c._dly)}else{n=0;o=j.length;g=180000;(function i(){f+=btoa(j.substr(n,g));n+=g;(n<o)?setTimeout(i,c._dly):a("data:image/tiff;base64,"+f)})()}})()},d)}};